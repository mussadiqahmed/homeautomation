<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home Automation PWA</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React and ReactDOM -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <!-- Babel for JSX -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.6/babel.min.js"></script>
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/favicon.ico">
  <!-- Favicon for PWA -->
  <link rel="icon" type="image/png" href="/favicon-192x192.png">
  <meta name="theme-color" content="#ffffff">
</head>
<body class="bg-gray-100">
  <div id="root" class="min-h-screen flex items-center justify-center"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Popup Component for Success/Danger Messages
    function Popup({ message, type, onClose }) {
      useEffect(() => {
        const timer = setTimeout(onClose, 3000);
        return () => clearTimeout(timer);
      }, [onClose]);

      return (
        <div class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50">
          <div
            class={`px-6 py-3 rounded-lg shadow-lg text-white flex items-center ${
              type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`}
          >
            <span class="mr-2 text-xl">
              {type === 'success' ? '‚úÖ' : '‚ùå'}
            </span>
            <span class="text-sm md:text-base">{message}</span>
          </div>
        </div>
      );
    }

    // Login Component
    function Login({ onLogin }) {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [popup, setPopup] = useState(null);

      const handleSubmit = (e) => {
        e.preventDefault();
        if (username === 'admin' && password === 'admin') {
          onLogin();
        } else {
          setPopup({ message: 'Invalid credentials', type: 'danger' });
        }
      };

      return (
        <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg w-full max-w-sm md:max-w-md">
          <h1 class="text-2xl md:text-3xl font-bold mb-6 text-center">Login</h1>
          <form onSubmit={handleSubmit}>
            <div class="mb-4">
              <label class="block text-gray-700 text-sm md:text-base">Username</label>
              <input
                type="text"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                class="w-full px-3 py-2 border rounded text-sm md:text-base"
                required
              />
            </div>
            <div class="mb-4">
              <label class="block text-gray-700 text-sm md:text-base">Password</label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                class="w-full px-3 py-2 border rounded text-sm md:text-base"
                required
              />
            </div>
            <button
              type="submit"
              class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 text-sm md:text-base"
            >
              Login
            </button>
          </form>
          {popup && (
            <Popup
              message={popup.message}
              type={popup.type}
              onClose={() => setPopup(null)}
            />
          )}
        </div>
      );
    }

    // Device Toggle Button Component
    function DeviceButton({ name, icon, state, onToggle }) {
      return (
        <div class="flex items-center justify-between bg-white p-4 rounded-lg shadow mb-4">
          <div class="flex items-center">
            <span class="text-2xl md:text-3xl mr-4">{icon}</span>
            <span class="font-medium text-base md:text-lg">{name}</span>
          </div>
          <button
            onClick={onToggle}
            class={`px-4 py-2 rounded text-sm md:text-base ${
              state ? 'bg-green-500' : 'bg-red-500'
            } text-white`}
          >
            {state ? 'ON' : 'OFF'}
          </button>
        </div>
      );
    }

    // Main App Component
    function App() {
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [bluetoothDevice, setBluetoothDevice] = useState(null);
      const [characteristic, setCharacteristic] = useState(null);
      const [deviceStates, setDeviceStates] = useState({
        light: false,
        fan: false,
        nightLamp: false,
      });
      const [popup, setPopup] = useState(null);
      const [isBluetoothLoading, setIsBluetoothLoading] = useState(false);

      // Check if Web Bluetooth is supported
      const isBluetoothSupported = !!navigator.bluetooth;

      // Check Bluetooth availability
      const checkBluetoothAvailability = async () => {
        try {
          const available = await navigator.bluetooth.getAvailability();
          if (!available) {
            setPopup({ message: 'Bluetooth is disabled or unavailable', type: 'danger' });
          }
          return available;
        } catch (error) {
          console.error('Error checking Bluetooth availability:', error);
          setPopup({ message: 'Error accessing Bluetooth', type: 'danger' });
          return false;
        }
      };

      // Connect to Bluetooth Device
      const connectBluetooth = async () => {
        if (!isBluetoothSupported) {
          setPopup({ message: 'Web Bluetooth not supported', type: 'danger' });
          return;
        }

        const isAvailable = await checkBluetoothAvailability();
        if (!isAvailable) return;

        setIsBluetoothLoading(true);
        console.log('Initiating Bluetooth device scan...');

        try {
          const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: ['00001101-0000-1000-8000-00805f9b34fb'], // Serial Port Profile UUID
          });
          console.log('Device selected:', device.name, device.id);
          const server = await device.gatt.connect();
          console.log('GATT server connected');
          const service = await server.getPrimaryService('00001101-0000-1000-8000-00805f9b34fb');
          console.log('Service found');
          const char = await service.getCharacteristic('00001101-0000-1000-8000-00805f9b34fb');
          console.log('Characteristic found');
          setBluetoothDevice(device);
          setCharacteristic(char);
          setPopup({ message: `Connected to ${device.name || 'device'}`, type: 'success' });
          device.addEventListener('gattserverdisconnected', () => {
            console.log('Bluetooth device disconnected');
            setBluetoothDevice(null);
            setCharacteristic(null);
            setPopup({ message: 'Bluetooth Disconnected', type: 'danger' });
          });
        } catch (error) {
          console.error('Bluetooth connection error:', error.message);
          setPopup({
            message: error.message.includes('User cancelled') 
              ? 'Bluetooth selection cancelled'
              : `Failed to connect: ${error.message}`,
            type: 'danger',
          });
        } finally {
          setIsBluetoothLoading(false);
        }
      };

      // Send command to Arduino
      const sendCommand = async (command) => {
        if (!characteristic) {
          setPopup({ message: 'Please connect to Bluetooth first', type: 'danger' });
          return;
        }
        try {
          const cleanCommand = command.trim(); // Ensure no extra whitespace
          const encoder = new TextEncoder();
          await characteristic.writeValue(encoder.encode(cleanCommand + '\n'));
          setPopup({ message: `Command "${cleanCommand}" sent`, type: 'success' });
        } catch (error) {
          console.error('Failed to send command:', error);
          setPopup({ message: `Failed to send command: ${error.message}`, type: 'danger' });
        }
      };

      // Toggle device state and send command
      const toggleDevice = (device) => {
        const newState = !deviceStates[device];
        setDeviceStates({ ...deviceStates, [device]: newState });
        const command = `${device} ${newState ? 'on' : 'off'}`;
        sendCommand(command);
      };

      // Handle all devices on/off
      const toggleAll = (state) => {
        const newStates = {
          light: state,
          fan: state,
          nightLamp: state,
        };
        setDeviceStates(newStates);
        sendCommand(`all ${state ? 'on' : 'off'}`);
      };

      if (!isLoggedIn) {
        return <Login onLogin={() => setIsLoggedIn(true)} />;
      }

      return (
        <div class="w-full max-w-sm md:max-w-2xl mx-auto p-4 md:p-6">
          <h1 class="text-2xl md:text-4xl font-bold mb-4 md:mb-6 text-center">Home Automation</h1>
          {!isBluetoothSupported && (
            <p class="text-red-500 mb-4 text-sm md:text-base">
              Web Bluetooth is not supported in this browser
            </p>
          )}
          <div class="mb-4 md:mb-6">
            {bluetoothDevice ? (
              <div class="flex items-center flex-col md:flex-row">
                <p class="mr-0 md:mr-4 mb-2 md:mb-0 text-sm md:text-base">
                  Connected to {bluetoothDevice.name || 'device'}
                </p>
                <button
                  onClick={() => bluetoothDevice.gatt.disconnect()}
                  class="bg-red-500 text-white px-4 py-2 rounded text-sm md:text-base"
                >
                  Disconnect
                </button>
              </div>
            ) : (
              <button
                onClick={connectBluetooth}
                class="bg-blue-500 text-white px-4 py-2 rounded w-full text-sm md:text-base disabled:bg-gray-400"
                disabled={!isBluetoothSupported || isBluetoothLoading}
              >
                {isBluetoothLoading ? 'Loading...' : 'Connect Bluetooth'}
              </button>
            )}
          </div>
          {isBluetoothSupported && !bluetoothDevice && !isBluetoothLoading && (
            <p class="text-yellow-600 mb-4 text-sm md:text-base">
              No Bluetooth devices found. Ensure HC-05 is powered and paired.
            </p>
          )}
          <DeviceButton
            name="Light"
            icon="üí°"
            state={deviceStates.light}
            onToggle={() => toggleDevice('light')}
          />
          <DeviceButton
            name="Fan"
            icon="üåÄ"
            state={deviceStates.fan}
            onToggle={() => toggleDevice('fan')}
          />
          <DeviceButton
            name="Night Lamp"
            icon="üåô"
            state={deviceStates.nightLamp}
            onToggle={() => toggleDevice('nightLamp')}
          />
          <div class="flex justify-between mt-4 md:mt-6">
            <button
              onClick={() => toggleAll(true)}
              class="bg-green-500 text-white px-4 py-2 rounded w-[48%] text-sm md:text-base"
            >
              All ON
            </button>
            <button
              onClick={() => toggleAll(false)}
              class="bg-red-500 text-white px-4 py-2 rounded w-[48%] text-sm md:text-base"
            >
              All OFF
            </button>
          </div>
          {popup && (
            <Popup
              message={popup.message}
              type={popup.type}
              onClose={() => setPopup(null)}
            />
          )}
        </div>
      );
    }

    // Render the App
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>

  <!-- Service Worker Registration -->
laubt  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(reg => console.log('Service Worker registered'))
          .catch(err => console.error('Service Worker registration failed:', err));
      });
    }
  </script>
</body>
</html>
